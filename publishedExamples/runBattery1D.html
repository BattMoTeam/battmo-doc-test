<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pseudo-Two-Dimensional (P2D) Lithium-Ion Battery Model &mdash; BattMo  documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/custom.css" type="text/css" />
    <link rel="shortcut icon" href="../_static/battmologo.ico"/>
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../_static/doctools.js?v=888ff710"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Gallery" href="../gallery.html" />
    <link rel="prev" title="BattMo Tutorial" href="battMoTutorial.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            BattMo
              <img src="../_static/battmologo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../tutorials.html">Getting Started</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="runJsonScript.html">BattMo example Json input</a></li>
<li class="toctree-l2"><a class="reference internal" href="battMoTutorial.html">BattMo Tutorial</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Pseudo-Two-Dimensional (P2D) Lithium-Ion Battery Model</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#import-the-required-modules-from-mrst">Import the required modules from MRST</a></li>
<li class="toctree-l3"><a class="reference internal" href="#setup-the-properties-of-li-ion-battery-materials-and-cell-design">Setup the properties of Li-ion battery materials and cell design</a></li>
<li class="toctree-l3"><a class="reference internal" href="#setup-the-geometry-and-computational-mesh">Setup the geometry and computational mesh</a></li>
<li class="toctree-l3"><a class="reference internal" href="#initialize-the-battery-model">Initialize the battery model.</a></li>
<li class="toctree-l3"><a class="reference internal" href="#compute-the-nominal-cell-capacity-and-choose-a-c-rate">Compute the nominal cell capacity and choose a C-Rate</a></li>
<li class="toctree-l3"><a class="reference internal" href="#setup-the-time-step-schedule">Setup the time step schedule</a></li>
<li class="toctree-l3"><a class="reference internal" href="#setup-the-initial-state-of-the-model">Setup the initial state of the model</a></li>
<li class="toctree-l3"><a class="reference internal" href="#setup-the-properties-of-the-nonlinear-solver">Setup the properties of the nonlinear solver</a></li>
<li class="toctree-l3"><a class="reference internal" href="#run-the-simulation">Run the simulation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#process-output-and-recover-the-output-voltage-and-current-from-the-output-states">Process output and recover the output voltage and current from the output states.</a></li>
<li class="toctree-l3"><a class="reference internal" href="#plot-the-the-output-voltage-and-current">Plot the the output voltage and current</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../gallery.html">Gallery</a></li>
<li class="toctree-l1"><a class="reference internal" href="../inputs.html">BattMo Li-ion battery</a></li>
<li class="toctree-l1"><a class="reference internal" href="../json.html">Json input description</a></li>
<li class="toctree-l1"><a class="reference internal" href="../geometryinput.html">Battery Geometries</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bibliography.html">References</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">BattMo</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../tutorials.html">Getting Started</a></li>
      <li class="breadcrumb-item active">Pseudo-Two-Dimensional (P2D) Lithium-Ion Battery Model</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/publishedExamples/runBattery1D.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="pseudo-two-dimensional-p2d-lithium-ion-battery-model">
<span id="runbattery1d"></span><h1>Pseudo-Two-Dimensional (P2D) Lithium-Ion Battery Model<a class="headerlink" href="#pseudo-two-dimensional-p2d-lithium-ion-battery-model" title="Link to this heading"></a></h1>
<p><em>Generated from runBattery1D.m</em></p>
<p>This example demonstrates how to setup a P2D model of a Li-ion battery and run a simple simulation.</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="c">% Clear the workspace and close open figures</span>
<span class="nb">clear</span><span class="w"> </span><span class="nb">all</span>
<span class="nb">close</span><span class="w"> </span><span class="nb">all</span>
<span class="nb">clc</span>
</pre></div>
</div>
<section id="import-the-required-modules-from-mrst">
<h2>Import the required modules from MRST<a class="headerlink" href="#import-the-required-modules-from-mrst" title="Link to this heading"></a></h2>
<p>load MRST modules</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">mrstModule</span><span class="w"> </span><span class="s">add</span><span class="w"> </span><span class="s">ad-core</span><span class="w"> </span><span class="s">mrst-gui</span><span class="w"> </span><span class="s">mpfa</span><span class="w"> </span><span class="s">agmg</span><span class="w"> </span><span class="s">linearsolvers</span>
</pre></div>
</div>
</section>
<section id="setup-the-properties-of-li-ion-battery-materials-and-cell-design">
<h2>Setup the properties of Li-ion battery materials and cell design<a class="headerlink" href="#setup-the-properties-of-li-ion-battery-materials-and-cell-design" title="Link to this heading"></a></h2>
<p>The properties and parameters of the battery cell, including the architecture and materials, are set using an instance of <code class="xref py py-class docutils literal notranslate"><span class="pre">BatteryInputParams</span></code>. This class is used to initialize the simulation and it propagates all the parameters throughout the submodels. The input parameters can be set manually or provided in json format. All the parameters for the model are stored in the paramobj object.</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">jsonstruct</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">parseBattmoJson</span><span class="p">(</span><span class="nb">fullfile</span><span class="p">(</span><span class="s">&#39;ParameterData&#39;</span><span class="p">,</span><span class="s">&#39;BatteryCellParameters&#39;</span><span class="p">,</span><span class="s">&#39;LithiumIonBatteryCell&#39;</span><span class="p">,</span><span class="s">&#39;lithium_ion_battery_nmc_graphite.json&#39;</span><span class="p">));</span>

<span class="c">% We define some shorthand names for simplicity.</span>
<span class="n">ne</span><span class="w">      </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;NegativeElectrode&#39;</span><span class="p">;</span>
<span class="n">pe</span><span class="w">      </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;PositiveElectrode&#39;</span><span class="p">;</span>
<span class="n">elyte</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;Electrolyte&#39;</span><span class="p">;</span>
<span class="n">thermal</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;ThermalModel&#39;</span><span class="p">;</span>
<span class="n">am</span><span class="w">      </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;ActiveMaterial&#39;</span><span class="p">;</span>
<span class="n">itf</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;Interface&#39;</span><span class="p">;</span>
<span class="n">sd</span><span class="w">      </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;SolidDiffusion&#39;</span><span class="p">;</span>
<span class="n">ctrl</span><span class="w">    </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;Control&#39;</span><span class="p">;</span>
<span class="n">cc</span><span class="w">      </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;CurrentCollector&#39;</span><span class="p">;</span>

<span class="n">jsonstruct</span><span class="p">.</span><span class="n">use_thermal</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="n">jsonstruct</span><span class="p">.</span><span class="n">include_current_collectors</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>

<span class="n">jsonstruct</span><span class="p">.(</span><span class="n">pe</span><span class="p">).(</span><span class="n">am</span><span class="p">).</span><span class="n">diffusionModelType</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;full&#39;</span><span class="p">;</span>
<span class="n">jsonstruct</span><span class="p">.(</span><span class="n">ne</span><span class="p">).(</span><span class="n">am</span><span class="p">).</span><span class="n">diffusionModelType</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;full&#39;</span><span class="p">;</span>

<span class="n">jsonstruct</span><span class="p">.</span><span class="n">use_particle_diffusion</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>

<span class="n">paramobj</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">BatteryInputParams</span><span class="p">(</span><span class="n">jsonstruct</span><span class="p">);</span>

<span class="n">paramobj</span><span class="p">.(</span><span class="n">ne</span><span class="p">).(</span><span class="n">am</span><span class="p">).</span><span class="n">InterDiffusionCoefficient</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="n">paramobj</span><span class="p">.(</span><span class="n">pe</span><span class="p">).(</span><span class="n">am</span><span class="p">).</span><span class="n">InterDiffusionCoefficient</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="n">paramobj</span><span class="p">.(</span><span class="n">ne</span><span class="p">).(</span><span class="n">am</span><span class="p">).(</span><span class="n">sd</span><span class="p">).</span><span class="n">N</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>
<span class="n">paramobj</span><span class="p">.(</span><span class="n">pe</span><span class="p">).(</span><span class="n">am</span><span class="p">).(</span><span class="n">sd</span><span class="p">).</span><span class="n">N</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>

<span class="n">paramobj</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">paramobj</span><span class="p">.</span><span class="n">validateInputParams</span><span class="p">();</span>

<span class="n">use_cccv</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="k">if</span><span class="w"> </span><span class="n">use_cccv</span>
<span class="w">    </span><span class="n">cccvstruct</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">struct</span><span class="p">(</span><span class="w"> </span><span class="s">&#39;controlPolicy&#39;</span><span class="w">     </span><span class="p">,</span><span class="w"> </span><span class="s">&#39;CCCV&#39;</span><span class="p">,</span><span class="w">  </span><span class="k">...</span>
<span class="w">                         </span><span class="s">&#39;initialControl&#39;</span><span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="s">&#39;discharging&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                         </span><span class="s">&#39;CRate&#39;</span><span class="w">             </span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="w">         </span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                         </span><span class="s">&#39;lowerCutoffVoltage&#39;</span><span class="p">,</span><span class="w"> </span><span class="mf">2.4</span><span class="w">       </span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                         </span><span class="s">&#39;upperCutoffVoltage&#39;</span><span class="p">,</span><span class="w"> </span><span class="mf">4.1</span><span class="w">       </span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                         </span><span class="s">&#39;dIdtLimit&#39;</span><span class="w">         </span><span class="p">,</span><span class="w"> </span><span class="mf">0.01</span><span class="w">      </span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                         </span><span class="s">&#39;dEdtLimit&#39;</span><span class="w">         </span><span class="p">,</span><span class="w"> </span><span class="mf">0.01</span><span class="p">);</span>
<span class="w">    </span><span class="n">cccvparamobj</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">CcCvControlModelInputParams</span><span class="p">(</span><span class="n">cccvstruct</span><span class="p">);</span>
<span class="w">    </span><span class="n">paramobj</span><span class="p">.</span><span class="n">Control</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">cccvparamobj</span><span class="p">;</span>
<span class="k">end</span>
</pre></div>
</div>
</section>
<section id="setup-the-geometry-and-computational-mesh">
<h2>Setup the geometry and computational mesh<a class="headerlink" href="#setup-the-geometry-and-computational-mesh" title="Link to this heading"></a></h2>
<p>Here, we setup the 1D computational mesh that will be used for the simulation. The required discretization parameters are already included in the class BatteryGenerator1D.</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">gen</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">BatteryGenerator1D</span><span class="p">();</span>

<span class="c">% Now, we update the paramobj with the properties of the mesh.</span>
<span class="n">paramobj</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">gen</span><span class="p">.</span><span class="n">updateBatteryInputParams</span><span class="p">(</span><span class="n">paramobj</span><span class="p">);</span>
</pre></div>
</div>
</section>
<section id="initialize-the-battery-model">
<h2>Initialize the battery model.<a class="headerlink" href="#initialize-the-battery-model" title="Link to this heading"></a></h2>
<p>The battery model is initialized by sending paramobj to the Battery class constructor. see <code class="xref py py-class docutils literal notranslate"><span class="pre">Battery</span></code>.</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">Battery</span><span class="p">(</span><span class="n">paramobj</span><span class="p">);</span>
<span class="n">model</span><span class="p">.</span><span class="n">AutoDiffBackend</span><span class="p">=</span><span class="w"> </span><span class="n">AutoDiffBackend</span><span class="p">();</span>

<span class="n">inspectgraph</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="k">if</span><span class="w"> </span><span class="n">inspectgraph</span>
<span class="w">    </span><span class="c">% plot the computational graph</span>
<span class="w">    </span><span class="n">cgt</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">ComputationalGraphTool</span><span class="p">(</span><span class="n">model</span><span class="p">);</span>
<span class="w">    </span><span class="n">cgt</span><span class="p">.</span><span class="n">getComputationalGraph</span><span class="p">(</span><span class="s">&#39;doplot&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span>
<span class="k">end</span>
</pre></div>
</div>
</section>
<section id="compute-the-nominal-cell-capacity-and-choose-a-c-rate">
<h2>Compute the nominal cell capacity and choose a C-Rate<a class="headerlink" href="#compute-the-nominal-cell-capacity-and-choose-a-c-rate" title="Link to this heading"></a></h2>
<p>The nominal capacity of the cell is calculated from the active materials. This value is then combined with the user-defined C-Rate to set the cell operational current.</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">CRate</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">model</span><span class="p">.</span><span class="n">Control</span><span class="p">.</span><span class="n">CRate</span><span class="p">;</span>
</pre></div>
</div>
</section>
<section id="setup-the-time-step-schedule">
<h2>Setup the time step schedule<a class="headerlink" href="#setup-the-time-step-schedule" title="Link to this heading"></a></h2>
<p>Smaller time steps are used to ramp up the current from zero to its operational value. Larger time steps are then used for the normal operation.</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="k">switch</span><span class="w"> </span><span class="n">model</span><span class="p">.(</span><span class="n">ctrl</span><span class="p">).</span><span class="n">controlPolicy</span>
<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="s">&#39;CCCV&#39;</span>
<span class="w">    </span><span class="n">total</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mf">3.5</span><span class="o">*</span><span class="nb">hour</span><span class="o">/</span><span class="n">CRate</span><span class="p">;</span>
<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="s">&#39;IEswitch&#39;</span>
<span class="w">    </span><span class="n">total</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mf">1.4</span><span class="o">*</span><span class="nb">hour</span><span class="o">/</span><span class="n">CRate</span><span class="p">;</span>
<span class="w">  </span><span class="k">otherwise</span>
<span class="w">    </span><span class="nb">error</span><span class="p">(</span><span class="s">&#39;control policy not recognized&#39;</span><span class="p">);</span>
<span class="k">end</span>

<span class="n">n</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span>
<span class="n">dt</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">total</span><span class="o">/</span><span class="n">n</span><span class="p">;</span>
<span class="nb">step</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">struct</span><span class="p">(</span><span class="s">&#39;val&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">dt</span><span class="o">*</span><span class="nb">ones</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="s">&#39;control&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">ones</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">));</span>

<span class="c">% we setup the control by assigning a source and stop function.</span>
<span class="c">% control = struct(&#39;CCCV&#39;, true);</span>
<span class="c">%  !!! Change this to an entry in the JSON with better variable names !!!</span>

<span class="k">switch</span><span class="w"> </span><span class="n">model</span><span class="p">.</span><span class="n">Control</span><span class="p">.</span><span class="n">controlPolicy</span>
<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="s">&#39;IEswitch&#39;</span>
<span class="w">    </span><span class="n">tup</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mf">0.1</span><span class="p">;</span><span class="w"> </span><span class="c">% rampup value for the current function, see rampupSwitchControl</span>
<span class="w">    </span><span class="n">srcfunc</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">@(</span><span class="nb">time</span><span class="p">,</span><span class="w"> </span><span class="n">I</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="p">)</span><span class="w"> </span><span class="n">rampupSwitchControl</span><span class="p">(</span><span class="nb">time</span><span class="p">,</span><span class="w"> </span><span class="n">tup</span><span class="p">,</span><span class="w"> </span><span class="n">I</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                                                </span><span class="n">model</span><span class="p">.</span><span class="n">Control</span><span class="p">.</span><span class="n">Imax</span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                                                </span><span class="n">model</span><span class="p">.</span><span class="n">Control</span><span class="p">.</span><span class="n">lowerCutoffVoltage</span><span class="p">);</span>
<span class="w">    </span><span class="c">% we setup the control by assigning a source and stop function.</span>
<span class="w">    </span><span class="n">control</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">struct</span><span class="p">(</span><span class="s">&#39;src&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">srcfunc</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;IEswitch&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span>
<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="s">&#39;CCCV&#39;</span>
<span class="w">    </span><span class="n">control</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">struct</span><span class="p">(</span><span class="s">&#39;CCCV&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span>
<span class="w">  </span><span class="k">otherwise</span>
<span class="w">    </span><span class="nb">error</span><span class="p">(</span><span class="s">&#39;control policy not recognized&#39;</span><span class="p">);</span>
<span class="k">end</span>

<span class="c">% This control is used to set up the schedule</span>
<span class="n">schedule</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">struct</span><span class="p">(</span><span class="s">&#39;control&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">control</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;step&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">step</span><span class="p">);</span>
</pre></div>
</div>
</section>
<section id="setup-the-initial-state-of-the-model">
<h2>Setup the initial state of the model<a class="headerlink" href="#setup-the-initial-state-of-the-model" title="Link to this heading"></a></h2>
<p>The initial state of the model is setup using the model.setupInitialState() method.</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">initstate</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">model</span><span class="p">.</span><span class="n">setupInitialState</span><span class="p">();</span>
</pre></div>
</div>
</section>
<section id="setup-the-properties-of-the-nonlinear-solver">
<h2>Setup the properties of the nonlinear solver<a class="headerlink" href="#setup-the-properties-of-the-nonlinear-solver" title="Link to this heading"></a></h2>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">nls</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">NonLinearSolver</span><span class="p">();</span>

<span class="n">linearsolver</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;direct&#39;</span><span class="p">;</span>
<span class="k">switch</span><span class="w"> </span><span class="n">linearsolver</span>
<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="s">&#39;agmg&#39;</span>
<span class="w">    </span><span class="n">mrstModule</span><span class="w"> </span><span class="nb">add</span><span class="w"> </span><span class="n">agmg</span>
<span class="w">    </span><span class="n">nls</span><span class="p">.</span><span class="n">LinearSolver</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">AGMGSolverAD</span><span class="p">(</span><span class="s">&#39;verbose&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;reduceToCell&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span>
<span class="w">    </span><span class="n">nls</span><span class="p">.</span><span class="n">LinearSolver</span><span class="p">.</span><span class="n">tolerance</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mf">1e-3</span><span class="p">;</span>
<span class="w">    </span><span class="n">nls</span><span class="p">.</span><span class="n">LinearSolver</span><span class="p">.</span><span class="n">maxIterations</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">30</span><span class="p">;</span>
<span class="w">    </span><span class="n">nls</span><span class="p">.</span><span class="n">maxIterations</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span>
<span class="w">    </span><span class="n">nls</span><span class="p">.</span><span class="n">verbose</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span>
<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="s">&#39;battery&#39;</span>
<span class="w">    </span><span class="n">nls</span><span class="p">.</span><span class="n">LinearSolver</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">LinearSolverBatteryExtra</span><span class="p">(</span><span class="s">&#39;verbose&#39;</span><span class="w">     </span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                                                </span><span class="s">&#39;reduceToCell&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                                                </span><span class="s">&#39;verbosity&#39;</span><span class="w">   </span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                                                </span><span class="s">&#39;reuse_setup&#39;</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                                                </span><span class="s">&#39;method&#39;</span><span class="w">      </span><span class="p">,</span><span class="w"> </span><span class="s">&#39;direct&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="n">nls</span><span class="p">.</span><span class="n">LinearSolver</span><span class="p">.</span><span class="n">tolerance</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mf">1e-4</span><span class="p">;</span>
<span class="w">  </span><span class="k">case</span><span class="w"> </span><span class="s">&#39;direct&#39;</span>
<span class="w">    </span><span class="nb">disp</span><span class="p">(</span><span class="s">&#39;standard direct solver&#39;</span><span class="p">)</span>
<span class="w">  </span><span class="k">otherwise</span>
<span class="w">    </span><span class="nb">error</span><span class="p">()</span>
<span class="k">end</span>

<span class="c">% Change default maximum iteration number in nonlinear solver</span>
<span class="n">nls</span><span class="p">.</span><span class="n">maxIterations</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span>
<span class="c">% Change default behavior of nonlinear solver, in case of error</span>
<span class="n">nls</span><span class="p">.</span><span class="n">errorOnFailure</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="n">nls</span><span class="p">.</span><span class="n">timeStepSelector</span><span class="p">=</span><span class="n">StateChangeTimeStepSelector</span><span class="p">(</span><span class="s">&#39;TargetProps&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{{</span><span class="s">&#39;Control&#39;</span><span class="p">,</span><span class="s">&#39;E&#39;</span><span class="p">}},</span><span class="w"> </span><span class="s">&#39;targetChangeAbs&#39;</span><span class="p">,</span><span class="w"> </span><span class="mf">0.03</span><span class="p">);</span>
<span class="c">% Change default tolerance for nonlinear solver</span>
<span class="n">model</span><span class="p">.</span><span class="n">nonlinearTolerance</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mf">1e-3</span><span class="o">*</span><span class="n">model</span><span class="p">.</span><span class="n">Control</span><span class="p">.</span><span class="n">Imax</span><span class="p">;</span>
<span class="c">% Set verbosity</span>
<span class="n">model</span><span class="p">.</span><span class="n">verbose</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>standard direct solver
</pre></div>
</div>
</section>
<section id="run-the-simulation">
<h2>Run the simulation<a class="headerlink" href="#run-the-simulation" title="Link to this heading"></a></h2>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">wellSols</span><span class="p">,</span><span class="w"> </span><span class="n">states</span><span class="p">,</span><span class="w"> </span><span class="n">report</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">simulateScheduleAD</span><span class="p">(</span><span class="n">initstate</span><span class="p">,</span><span class="w"> </span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">schedule</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;OutputMinisteps&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;NonLinearSolver&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">nls</span><span class="p">);</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Solving timestep 001/100:                                            -&gt; 50 Seconds, 399 Milliseconds
=================================================================================================================================================================================================================================================================
| It # | elyte_massCons (cell) | elyte_chargeCons (cell) | ne_am_chargeCons (cell) | pe_am_chargeCons (cell) | ne_am_sd_massCons (cell) | ne_am_sd_soliddiffeq (cell) | pe_am_sd_massCons (cell) | pe_am_sd_soliddiffeq (cell) | EIeq (cell) | controlEq (ctrl) |
=================================================================================================================================================================================================================================================================
|    1 |*0.00e+00              |*0.00e+00                |*0.00e+00                |*0.00e+00                |*0.00e+00                 |*0.00e+00                    |*0.00e+00                 |*0.00e+00                    | 3.11e+01    |*0.00e+00         |
|    2 | 9.60e-01              | 5.73e-01                | 4.50e-01                | 2.25e-01                | 1.36e-01                 | 1.36e-01                    | 8.30e-02                 | 8.30e-02                    |*2.60e-09    |*0.00e+00         |
|    3 |*2.77e-03              |*1.66e-03                |*1.36e-03                |*4.12e-04                |*4.09e-04                 |*4.09e-04                    |*1.52e-04                 |*1.52e-04                    |*2.60e-09    |*0.00e+00         |
=================================================================================================================================================================================================================================================================
...
</pre></div>
</div>
</section>
<section id="process-output-and-recover-the-output-voltage-and-current-from-the-output-states">
<h2>Process output and recover the output voltage and current from the output states.<a class="headerlink" href="#process-output-and-recover-the-output-voltage-and-current-from-the-output-states" title="Link to this heading"></a></h2>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">ind</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">cellfun</span><span class="p">(@(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="n">not</span><span class="p">(</span><span class="nb">isempty</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span><span class="w"> </span><span class="n">states</span><span class="p">);</span>
<span class="n">states</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">states</span><span class="p">(</span><span class="n">ind</span><span class="p">);</span>
<span class="n">E</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">cellfun</span><span class="p">(@(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">Control</span><span class="p">.</span><span class="n">E</span><span class="p">,</span><span class="w"> </span><span class="n">states</span><span class="p">);</span>
<span class="n">I</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">cellfun</span><span class="p">(@(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">Control</span><span class="p">.</span><span class="n">I</span><span class="p">,</span><span class="w"> </span><span class="n">states</span><span class="p">);</span>
<span class="n">Tmax</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">cellfun</span><span class="p">(@(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="nb">max</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">ThermalModel</span><span class="p">.</span><span class="n">T</span><span class="p">),</span><span class="w"> </span><span class="n">states</span><span class="p">);</span>
<span class="c">% [SOCN, SOCP] =  cellfun(@(x) model.calculateSOC(x), states);</span>
<span class="nb">time</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">cellfun</span><span class="p">(@(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">states</span><span class="p">);</span>

<span class="nb">plot</span><span class="p">(</span><span class="nb">time</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="p">);</span>
</pre></div>
</div>
<figure class="align-default" style="width: 100%">
<img alt="../_images/runBattery1D_01.png" src="../_images/runBattery1D_01.png" />
</figure>
</section>
<section id="plot-the-the-output-voltage-and-current">
<h2>Plot the the output voltage and current<a class="headerlink" href="#plot-the-the-output-voltage-and-current" title="Link to this heading"></a></h2>
<p>plotDashboard(model, states, ‘step’, 0);</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="cm">%{</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="battMoTutorial.html" class="btn btn-neutral float-left" title="BattMo Tutorial" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../gallery.html" class="btn btn-neutral float-right" title="Gallery" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Simon Clark.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>