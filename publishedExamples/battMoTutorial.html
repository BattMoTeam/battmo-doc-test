<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BattMo Tutorial &mdash; BattMo  documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/custom.css" type="text/css" />
    <link rel="shortcut icon" href="../_static/battmologo.ico"/>
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../_static/doctools.js?v=888ff710"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Pseudo-Two-Dimensional (P2D) Lithium-Ion Battery Model" href="runBattery1D.html" />
    <link rel="prev" title="BattMo example Json input" href="runJsonScript.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            BattMo
              <img src="../_static/battmologo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../tutorials.html">Getting Started</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="runJsonScript.html">BattMo example Json input</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">BattMo Tutorial</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#setting-up-the-environment">Setting up the environment</a></li>
<li class="toctree-l3"><a class="reference internal" href="#specifying-the-physical-model">Specifying the physical model</a></li>
<li class="toctree-l3"><a class="reference internal" href="#setting-up-the-geometry">Setting up the geometry</a></li>
<li class="toctree-l3"><a class="reference internal" href="#initialising-the-battery-model-object">Initialising the battery model object</a></li>
<li class="toctree-l3"><a class="reference internal" href="#plotting-the-ocp-curves">Plotting the OCP curves</a></li>
<li class="toctree-l3"><a class="reference internal" href="#controlling-the-simulation">Controlling the simulation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#setting-the-initial-state-of-the-battery">Setting the initial state of the battery</a></li>
<li class="toctree-l3"><a class="reference internal" href="#running-the-simulation">Running the simulation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#plotting-the-results">Plotting the results</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="runBattery1D.html">Pseudo-Two-Dimensional (P2D) Lithium-Ion Battery Model</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../gallery.html">Gallery</a></li>
<li class="toctree-l1"><a class="reference internal" href="../inputs.html">BattMo Li-ion battery</a></li>
<li class="toctree-l1"><a class="reference internal" href="../json.html">Json input description</a></li>
<li class="toctree-l1"><a class="reference internal" href="../geometryinput.html">Battery Geometries</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bibliography.html">References</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">BattMo</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../tutorials.html">Getting Started</a></li>
      <li class="breadcrumb-item active">BattMo Tutorial</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/publishedExamples/battMoTutorial.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="battmo-tutorial">
<span id="battmotutorial"></span><h1>BattMo Tutorial<a class="headerlink" href="#battmo-tutorial" title="Link to this heading"></a></h1>
<p><em>Generated from battMoTutorial.m</em></p>
<p>This tutorial explains how to setup and run a simulation in BattMo</p>
<section id="setting-up-the-environment">
<h2>Setting up the environment<a class="headerlink" href="#setting-up-the-environment" title="Link to this heading"></a></h2>
<p>BattMo uses functionality from <code class="xref py py-mod docutils literal notranslate"><span class="pre">MRST</span></code>. This functionality is collected into modules where each module contains code for doing specific things. To use this functionality we must add these modules to the matlab path by running:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">mrstModule</span><span class="w"> </span><span class="s">add</span><span class="w"> </span><span class="s">ad-core</span><span class="w"> </span><span class="s">mrst-gui</span><span class="w"> </span><span class="s">mpfa</span><span class="w"> </span><span class="s">agmg</span><span class="w"> </span><span class="s">linearsolvers</span>
</pre></div>
</div>
</section>
<section id="specifying-the-physical-model">
<h2>Specifying the physical model<a class="headerlink" href="#specifying-the-physical-model" title="Link to this heading"></a></h2>
<p>In this tutorial we will simulate a lithium-ion battery consisting of a negative electrode, a positive electrode and an electrolyte. BattMo comes with some pre-defined models which can be loaded from JSON files. Here we will load the basic lithium-ion model JSON file which comes with Battmo.</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">fname</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">fullfile</span><span class="p">(</span><span class="s">&#39;ParameterData&#39;</span><span class="p">,</span><span class="s">&#39;BatteryCellParameters&#39;</span><span class="p">,</span><span class="k">...</span>
<span class="w">    </span><span class="s">&#39;LithiumIonBatteryCell&#39;</span><span class="p">,</span><span class="s">&#39;lithium_ion_battery_nmc_graphite.json&#39;</span><span class="p">);</span>
<span class="n">jsonstruct</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">parseBattmoJson</span><span class="p">(</span><span class="n">fname</span><span class="p">);</span>
</pre></div>
</div>
<p>The parseBattmoJson function parses the JSON input and creates a matlab structure containing the same fields as the JSON input. This structure can be changed to setup the model in the way that we want.
In this instance we will exclude temperature effects by setting use_thermal to false.</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">jsonstruct</span><span class="p">.</span><span class="n">use_thermal</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
</pre></div>
</div>
<p>We will also not use current collectors in this example:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">jsonstruct</span><span class="p">.</span><span class="n">include_current_collectors</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
</pre></div>
</div>
<p>The structure created in the jsonstruct follows the same hierarchy as the fields in the JSON input file. These can be referenced by name in the jsonstruct. To make life easier for ourselves we define some shorthand names for various parts of the structure.</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">ne</span><span class="w">      </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;NegativeElectrode&#39;</span><span class="p">;</span>
<span class="n">pe</span><span class="w">      </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;PositiveElectrode&#39;</span><span class="p">;</span>
<span class="n">elyte</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;Electrolyte&#39;</span><span class="p">;</span>
<span class="n">thermal</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;ThermalModel&#39;</span><span class="p">;</span>
<span class="n">co</span><span class="w">      </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;Coating&#39;</span><span class="p">;</span>
<span class="n">am</span><span class="w">      </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;ActiveMaterial&#39;</span><span class="p">;</span>
<span class="n">itf</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;Interface&#39;</span><span class="p">;</span>
<span class="n">sd</span><span class="w">      </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;SolidDiffusion&#39;</span><span class="p">;</span>
<span class="n">ctrl</span><span class="w">    </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;Control&#39;</span><span class="p">;</span>
<span class="n">cc</span><span class="w">      </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;CurrentCollector&#39;</span><span class="p">;</span>
</pre></div>
</div>
<p>Now we can set the diffusion model type for the active material (am) in the positive (pe) and negative (ne) electrodes to ‘full’.</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">jsonstruct</span><span class="p">.(</span><span class="n">pe</span><span class="p">).(</span><span class="n">am</span><span class="p">).</span><span class="n">diffusionModelType</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;full&#39;</span><span class="p">;</span>
<span class="n">jsonstruct</span><span class="p">.(</span><span class="n">ne</span><span class="p">).(</span><span class="n">am</span><span class="p">).</span><span class="n">diffusionModelType</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&#39;full&#39;</span><span class="p">;</span>
</pre></div>
</div>
<p>To see which other types of diffusion model are available one can view <code class="xref py py-class docutils literal notranslate"><span class="pre">ActiveMaterialInputParams</span></code>. This class is used to initialize the simulation and is accessed by various parts of the simulator during the simulation. This class is instantiated using the jsonstruct we just created:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">paramobj</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">BatteryInputParams</span><span class="p">(</span><span class="n">jsonstruct</span><span class="p">);</span>
<span class="n">paramobj</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">paramobj</span><span class="p">.</span><span class="n">validateInputParams</span><span class="p">();</span>
</pre></div>
</div>
<p>It is also possible to update the properties of this paramobj in a similar way to updating the jsonstruct. Here we set the discretisation level for the diffusion model. Other input parameters for the full diffusion model can be found here: <code class="xref py py-class docutils literal notranslate"><span class="pre">FullSolidDiffusionModelInputParams</span></code>.</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">paramobj</span><span class="p">.(</span><span class="n">ne</span><span class="p">).(</span><span class="n">co</span><span class="p">).(</span><span class="n">am</span><span class="p">).(</span><span class="n">sd</span><span class="p">).</span><span class="n">N</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>
<span class="n">paramobj</span><span class="p">.(</span><span class="n">pe</span><span class="p">).(</span><span class="n">co</span><span class="p">).(</span><span class="n">am</span><span class="p">).(</span><span class="n">sd</span><span class="p">).</span><span class="n">N</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>
</pre></div>
</div>
</section>
<section id="setting-up-the-geometry">
<h2>Setting up the geometry<a class="headerlink" href="#setting-up-the-geometry" title="Link to this heading"></a></h2>
<p>Here, we setup the 1D computational mesh that will be used for the simulation. The required discretization parameters are already included in the class BatteryGenerator1D. Classes for generating other geometries can be found in the BattMo/Battery/BatteryGeometry folder.</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">gen</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">BatteryGenerator1D</span><span class="p">();</span>
</pre></div>
</div>
<p>Now, we update the paramobj with the properties of the mesh. This function will update relevent parameters in the paramobj object and make sure we have all the required parameters for the model geometry chosen.</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">paramobj</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">gen</span><span class="p">.</span><span class="n">updateBatteryInputParams</span><span class="p">(</span><span class="n">paramobj</span><span class="p">);</span>
</pre></div>
</div>
</section>
<section id="initialising-the-battery-model-object">
<h2>Initialising the battery model object<a class="headerlink" href="#initialising-the-battery-model-object" title="Link to this heading"></a></h2>
<p>The battery model is initialized by sending paramobj to the Battery class constructor. see <code class="xref py py-class docutils literal notranslate"><span class="pre">Battery</span></code>.</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">Battery</span><span class="p">(</span><span class="n">paramobj</span><span class="p">);</span>
</pre></div>
</div>
<p>In BattMo a battery model is actually a collection of submodels: Electrolyte, Negative Electrode, Positive Electrode, Thermal Model and Control Model. The battery class contains all of these submodels and various other parameters necessary to run the simulation.</p>
</section>
<section id="plotting-the-ocp-curves">
<h2>Plotting the OCP curves<a class="headerlink" href="#plotting-the-ocp-curves" title="Link to this heading"></a></h2>
<p>We can inspect the model object to find out which parameters are being used. For instance the information we need to plot the OCP curves for the positive and negative electrodes can be found in the interface structure of each electrode.</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">T</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mf">298.15</span><span class="p">;</span>
<span class="n">elde</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">{</span><span class="n">ne</span><span class="p">,</span><span class="w"> </span><span class="n">pe</span><span class="p">};</span>

<span class="n">figure</span>
<span class="s">hold</span><span class="w"> </span><span class="s">on</span>
<span class="k">for</span><span class="w"> </span><span class="nb">i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="nb">numel</span><span class="p">(</span><span class="n">elde</span><span class="p">)</span>
<span class="w">    </span><span class="n">el_itf</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">model</span><span class="p">.(</span><span class="n">elde</span><span class="p">{</span><span class="nb">i</span><span class="p">}).(</span><span class="n">co</span><span class="p">).(</span><span class="n">am</span><span class="p">).(</span><span class="n">itf</span><span class="p">);</span>

<span class="w">    </span><span class="n">theta100</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">el_itf</span><span class="p">.</span><span class="n">guestStoichiometry100</span><span class="p">;</span>
<span class="w">    </span><span class="n">theta0</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="n">el_itf</span><span class="p">.</span><span class="n">guestStoichiometry0</span><span class="p">;</span>
<span class="w">    </span><span class="n">cmax</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="n">el_itf</span><span class="p">.</span><span class="n">saturationConcentration</span><span class="p">;</span>

<span class="w">    </span><span class="n">soc</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="nb">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="n">theta</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">soc</span><span class="o">*</span><span class="n">theta100</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">soc</span><span class="p">)</span><span class="o">*</span><span class="n">theta0</span><span class="p">;</span>
<span class="w">    </span><span class="n">c</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="n">theta</span><span class="o">.*</span><span class="n">cmax</span><span class="p">;</span>
<span class="w">    </span><span class="n">OCP</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="n">el_itf</span><span class="p">.</span><span class="n">computeOCPFunc</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">cmax</span><span class="p">);</span>

<span class="w">    </span><span class="nb">plot</span><span class="p">(</span><span class="n">soc</span><span class="p">,</span><span class="w"> </span><span class="n">OCP</span><span class="p">)</span>
<span class="k">end</span>
<span class="nb">xlabel</span><span class="p">(</span><span class="s">&#39;SOC [-]&#39;</span><span class="p">)</span>
<span class="nb">ylabel</span><span class="p">(</span><span class="s">&#39;OCV [V]&#39;</span><span class="p">)</span>
<span class="nb">title</span><span class="p">(</span><span class="s">&#39;OCV for both electrodes&#39;</span><span class="p">);</span>
<span class="nb">legend</span><span class="p">(</span><span class="n">elde</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="controlling-the-simulation">
<h2>Controlling the simulation<a class="headerlink" href="#controlling-the-simulation" title="Link to this heading"></a></h2>
<p>The control model specifies how the simulation is controlled. This can also be thought of as the boundary conditions of the simulation.
In the first instance we use IEswitch control policy. We set the total time scaled by the CRate in the model. The CRate has been set by the json file. We can access it here:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">CRate</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">model</span><span class="p">.</span><span class="n">Control</span><span class="p">.</span><span class="n">CRate</span><span class="p">;</span>
<span class="n">total</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mf">1.4</span><span class="o">*</span><span class="nb">hour</span><span class="o">/</span><span class="n">CRate</span><span class="p">;</span>
</pre></div>
</div>
<p>We want to break this total time into 100 timesteps. To begin with we will use equal values for each timestep.
We create a structure containing the length of each step in seconds (‘val’) and also which control to use for each step (‘control’).
In this case we use control 1 for all steps. This means that the functions used to setup the control values are the same at each step.</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">n</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span>
<span class="n">dt</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">total</span><span class="o">/</span><span class="n">n</span><span class="p">;</span>
<span class="nb">step</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">struct</span><span class="p">(</span><span class="s">&#39;val&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">dt</span><span class="o">*</span><span class="nb">ones</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="s">&#39;control&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">ones</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">));</span>
</pre></div>
</div>
<p>For the IESwitch control we will switch between controlling the current or the voltage based on some max and min values. We do this using the rampupSwitchControl function.
Smaller time steps are used to ramp up the current from zero to its operational value. Larger time steps are then used for the normal operation.
This function also contains the logic about when to switch using constant current to constant voltage.
First we set a parameter to control how the current values increase between zero and the desired value. Then we assign the rampupSwitchControl function to a variable as an anonymous function.</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">tup</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mf">0.1</span><span class="p">;</span>
<span class="n">srcfunc</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">@(</span><span class="nb">time</span><span class="p">,</span><span class="w"> </span><span class="n">I</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="p">)</span><span class="w"> </span><span class="n">rampupSwitchControl</span><span class="p">(</span><span class="nb">time</span><span class="p">,</span><span class="w"> </span><span class="n">tup</span><span class="p">,</span><span class="w"> </span><span class="n">I</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                                            </span><span class="n">model</span><span class="p">.</span><span class="n">Control</span><span class="p">.</span><span class="n">Imax</span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                                            </span><span class="n">model</span><span class="p">.</span><span class="n">Control</span><span class="p">.</span><span class="n">lowerCutoffVoltage</span><span class="p">);</span>
</pre></div>
</div>
<p>We create a control structure containing the source function and specifying that we want to use IESwitch control:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">control</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">struct</span><span class="p">(</span><span class="s">&#39;src&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">srcfunc</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;IEswitch&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span>
</pre></div>
</div>
<p>Finally we collect the control and step structures together in a schedule struct which is the schedule which the simulation will follow:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">schedule</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">struct</span><span class="p">(</span><span class="s">&#39;control&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">control</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;step&#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">step</span><span class="p">);</span>
</pre></div>
</div>
</section>
<section id="setting-the-initial-state-of-the-battery">
<h2>Setting the initial state of the battery<a class="headerlink" href="#setting-the-initial-state-of-the-battery" title="Link to this heading"></a></h2>
<p>To run simulation we need to know the starting point which we will run it from, in terms of the value of the primary variables being modelled at the start of the simulation. The initial state of the model is setup using model.setupInitialState() Here we take the state of charge (SOC) given in the input and calculate equilibrium concentration based on theta0, theta100 and cmax.</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">initstate</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">model</span><span class="p">.</span><span class="n">setupInitialState</span><span class="p">();</span>
</pre></div>
</div>
</section>
<section id="running-the-simulation">
<h2>Running the simulation<a class="headerlink" href="#running-the-simulation" title="Link to this heading"></a></h2>
<p>Once we have the initial state, the model and the schedule, we can call the simulateScheduleAD function which will actually run the simulation:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">wellSols</span><span class="p">,</span><span class="w"> </span><span class="n">states</span><span class="p">,</span><span class="w"> </span><span class="n">report</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">simulateScheduleAD</span><span class="p">(</span><span class="n">initstate</span><span class="p">,</span><span class="w"> </span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">schedule</span><span class="p">);</span>
</pre></div>
</div>
<p>The outputs from the simulation are: - wellSols: which provides the current and voltage of the battery at each timestep. (This naming convention is a hangover from MRST where we model reservoir injection via injection wells). - states: which contains the values of the primary variables in the model at each timestep. - reports: which contains technical information about the steps used in the numerical solvers.</p>
</section>
<section id="plotting-the-results">
<h2>Plotting the results<a class="headerlink" href="#plotting-the-results" title="Link to this heading"></a></h2>
<p>To get the results we use the matlab cellfun function to extract the values Control.E, Control.I and time from each timestep (cell in the cell array) in states. We can then plot the vectors.</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">E</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">cellfun</span><span class="p">(@(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">Control</span><span class="p">.</span><span class="n">E</span><span class="p">,</span><span class="w"> </span><span class="n">states</span><span class="p">);</span>
<span class="n">I</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">cellfun</span><span class="p">(@(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">Control</span><span class="p">.</span><span class="n">I</span><span class="p">,</span><span class="w"> </span><span class="n">states</span><span class="p">);</span>
<span class="nb">time</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">cellfun</span><span class="p">(@(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">time</span><span class="p">,</span><span class="w"> </span><span class="n">states</span><span class="p">);</span>

<span class="nb">set</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;defaultlinelinewidth&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">);</span>
<span class="nb">set</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;DefaultAxesFontSize&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">);</span>
<span class="nb">set</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&#39;defaulttextfontsize&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">18</span><span class="p">);</span>

<span class="nb">figure</span><span class="p">()</span>

<span class="nb">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="nb">plot</span><span class="p">(</span><span class="nb">time</span><span class="o">/</span><span class="nb">hour</span><span class="p">,</span><span class="w"> </span><span class="n">E</span><span class="p">)</span>
<span class="nb">xlabel</span><span class="p">(</span><span class="s">&#39;time [hours]&#39;</span><span class="p">)</span>
<span class="nb">ylabel</span><span class="p">(</span><span class="s">&#39;Cell Voltage [V]&#39;</span><span class="p">)</span>

<span class="nb">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="nb">plot</span><span class="p">(</span><span class="nb">time</span><span class="o">/</span><span class="nb">hour</span><span class="p">,</span><span class="w"> </span><span class="n">I</span><span class="p">)</span>
<span class="nb">xlabel</span><span class="p">(</span><span class="s">&#39;time [hours]&#39;</span><span class="p">)</span>
<span class="nb">ylabel</span><span class="p">(</span><span class="s">&#39;Cell Current [A]&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Solving timestep 001/100:                                            -&gt; 50 Seconds, 399 Milliseconds
Solving timestep 002/100: 50 Seconds, 399 Milliseconds               -&gt; 100 Seconds, 799 Milliseconds
Solving timestep 003/100: 100 Seconds, 799 Milliseconds              -&gt; 151 Seconds, 199 Milliseconds
Solving timestep 004/100: 151 Seconds, 199 Milliseconds              -&gt; 201 Seconds, 599 Milliseconds
Solving timestep 005/100: 201 Seconds, 599 Milliseconds              -&gt; 252 Seconds
Solving timestep 006/100: 252 Seconds                                -&gt; 302 Seconds, 399 Milliseconds
Solving timestep 007/100: 302 Seconds, 399 Milliseconds              -&gt; 352 Seconds, 799 Milliseconds
Solving timestep 008/100: 352 Seconds, 799 Milliseconds              -&gt; 403 Seconds, 199 Milliseconds
...
</pre></div>
</div>
<figure class="align-default" style="width: 100%">
<img alt="../_images/battMoTutorial_01.png" src="../_images/battMoTutorial_01.png" />
</figure>
<figure class="align-default" style="width: 100%">
<img alt="../_images/battMoTutorial_02.png" src="../_images/battMoTutorial_02.png" />
</figure>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="runJsonScript.html" class="btn btn-neutral float-left" title="BattMo example Json input" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="runBattery1D.html" class="btn btn-neutral float-right" title="Pseudo-Two-Dimensional (P2D) Lithium-Ion Battery Model" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Simon Clark.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>